<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <meta name="author" content="Preslav Rachev">
    <meta name="description" content="Not logging enough is as equally bad, as logging too much. What developers need is a turn-key way to log requests on demand." />
    <meta name="keywords" content="programming, golang, python, elixir, Programming, Python, Flask" />
    <meta name="robots" content="noodp" />
    <meta name="theme-color" content="" />
    <link rel="canonical" href="https://preslav.me/2020/06/05/on-demand-request-logging-in-flask/" />

    
    
    <title>On-Demand Request Logging in Flask · Random Bits of Wisdom</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    
    
    <link rel="stylesheet" href="https://preslav.me/style.main.min.f84d6c0bd7277a0da9d1f4e0e893918c0b07491e54e74d802499c473ec868f38.css" />
    <link rel="stylesheet" href="https://preslav.me/site.min.af179bcb4919068a7c5f6ed21056ad75fc124f28175c73b7cda6a453e488853e.css" />
    <link rel="me" href="https://twitter.com/preslavrachev">

    

    <meta itemprop="name" content="On-Demand Request Logging in Flask">
<meta itemprop="description" content="Not logging enough is as equally bad, as logging too much. What developers need is a turn-key way to log requests on demand.">


<meta itemprop="datePublished" content="2020-06-05T23:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-06-05T23:00:00&#43;00:00" />
<meta itemprop="wordCount" content="991">



<meta itemprop="keywords" content="Programming,Python,Flask," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="On-Demand Request Logging in Flask"/>
<meta name="twitter:description" content="Not logging enough is as equally bad, as logging too much. What developers need is a turn-key way to log requests on demand."/>

    <meta property="og:title" content="On-Demand Request Logging in Flask" />
<meta property="og:description" content="Not logging enough is as equally bad, as logging too much. What developers need is a turn-key way to log requests on demand." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://preslav.me/2020/06/05/on-demand-request-logging-in-flask/" />
<meta property="article:published_time" content="2020-06-05T23:00:00+00:00" />
<meta property="article:modified_time" content="2020-06-05T23:00:00+00:00" />

    
    
    
    <meta name="twitter:image" content="https://images.unsplash.com/photo-1580894897591-ff1e18c89183?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1280&q=80">
    <meta property="og:image" content="https://images.unsplash.com/photo-1580894897591-ff1e18c89183?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1280&q=80">
    

    
    
    

    </head>
<body class=" post-template ">

    <div class="site-wrapper">

<header class="site-header"><div class="outer site-nav-main">
    <div class="inner"><nav class="site-nav">
    <div class="site-nav-left">
        
            <a class="site-nav-logo" href="https://preslav.me">Random Bits of Wisdom</a>
        
        
        <div class="site-nav-content">
            <ul class="nav" role="menu">
                
                <li class="nav-home" role="menuitem"><a href="/about/">About Me</a></li>
                
                <li class="nav-home" role="menuitem"><a href="/projects/">My Projects</a></li>
                
                <li class="nav-home" role="menuitem"><a href="/collections/">My Collections</a></li>
                
                <li class="nav-home" role="menuitem"><a href="/contact/">Contact</a></li>
                
            </ul>
        </div>
        
    </div>
</nav>

</div>
</div></header>

<main id="site-main" class="site-main outer">
    <div class="inner">

        <article
            class="post-full post  no-image ">

            <header class="post-full-header">

                
                
                <section class="post-full-tags">
                    <a
                        href="/tags/programming">Programming</a>
                </section>
                

                <h1 class="post-full-title">On-Demand Request Logging in Flask</h1>

                

                <div class="post-full-byline">
                    <section class="post-full-byline-content">

                        <ul class="author-list">
    <li class="author-list-item">
        <div class="author-card">
            <div class="author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg></div>
            <div class="author-info">
                <div class="author-info">
                    <h2>Preslav Rachev</h2>
                </div>
            </div>
        </div>
        <a href="#" class="author-avatar author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg></a>
    </li>
</ul>

                        <section class="post-full-byline-meta">
                            
                            <h4 class="author-name">Preslav Rachev</h4>
                            
                            <div class="byline-meta-content">
                                <time class="byline-meta-date"
                                    datetime="2020-116-06">5 June 2020</time>
                            </div>
                            <div class="byline-meta-content">
                                <span class="byline-reading-time"
                                    style="font-size: 1rem">
                                    5 min read</span>
                            </div>
                        </section>

                    </section>
                    <div class="byline-meta-content">
                        
                        <a class="resp-sharing-button__link"
                            href="https://twitter.com/intent/tweet/?text=On-Demand%20Request%20Logging%20in%20Flask&amp;url=https%3a%2f%2fpreslav.me%2f2020%2f06%2f05%2fon-demand-request-logging-in-flask%2f&amp;via=preslavrachev"
                            target="_blank" rel="noopener" aria-label="">
                            <div
                                class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small">
                                <div aria-hidden="true"
                                    class="resp-sharing-button__icon resp-sharing-button__icon--solid">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 24 24"
                                        style="width: 20px; height: 20px">
                                        <path
                                            d="M23.44 4.83c-.8.37-1.5.38-2.22.02.93-.56.98-.96 1.32-2.02-.88.52-1.86.9-2.9 1.1-.82-.88-2-1.43-3.3-1.43-2.5 0-4.55 2.04-4.55 4.54 0 .36.03.7.1 1.04-3.77-.2-7.12-2-9.36-4.75-.4.67-.6 1.45-.6 2.3 0 1.56.8 2.95 2 3.77-.74-.03-1.44-.23-2.05-.57v.06c0 2.2 1.56 4.03 3.64 4.44-.67.2-1.37.2-2.06.08.58 1.8 2.26 3.12 4.25 3.16C5.78 18.1 3.37 18.74 1 18.46c2 1.3 4.4 2.04 6.97 2.04 8.35 0 12.92-6.92 12.92-12.93 0-.2 0-.4-.02-.6.9-.63 1.96-1.22 2.56-2.14z" />
                                    </svg>
                                </div>
                            </div>
                        </a>
                        
                        <a class="resp-sharing-button__link"
                            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fpreslav.me%2f2020%2f06%2f05%2fon-demand-request-logging-in-flask%2f"
                            target="_blank" rel="noopener" aria-label="">
                            <div
                                class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small">
                                <div aria-hidden="true"
                                    class="resp-sharing-button__icon resp-sharing-button__icon--solid">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        style="width: 20px; height: 20px"
                                        viewBox="0 0 24 24">
                                        <path
                                            d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z" />
                                    </svg>
                                </div>
                            </div>
                        </a>

                    </div>
                </div>
            </header>

            

            <section class="post-full-content">
                <div class="post-content">
                    

<p>Printing out just the right amount of production logs is an art that sometimes borders the realm of Dark Magic. From my experience building software, most developers either log too much, or don’t log anything at all. Not enough information can make bug hunting more difficult. On the other hand, too many log traces hamper code readability and don’t necessarily make one’s duties easier.</p>

<p>In reality, what everyone wants, are <strong>logs on demand</strong>. Most programming environments already partially take care of this, by logging errors separately. Yet, not always will a wrong behaviour lead to an error. Plus, an error log would rarely contain the particular execution context that led to the error.</p>

<p>It would be great, if one were able to manually turn on logging, and only in certain cases. In the context of a Web applications, <em>certain cases</em> == <em>certain requests</em>. For the standard Flask-like Python Web app, this is actually very easy to achieve.</p>

<h1 id="basic-request-tracing">Basic Request Tracing</h1>

<p>I will use Flask, because it is the easiest to demonstrate. The idea should be relatively easy to reuse with other frameworks though.</p>

<p>Let’s say, we want to write a log every time our Flask API gets called with a certain URL parameter (let’s call it <code>trace_id</code>). The simplest thing one can do, is add a <code>@before_request</code> interceptor:</p>

<pre><code class="language-python">app = Flask(__name__)

@app.before_request
def request_tracer():
    if &quot;trace_id&quot; in request.args:
        # DO something, like log the request args, body, etc
	    # Make sure to include the trace_id as well, so you can
        # search for it in the logs
</code></pre>

<p>This function will be called before each request. If you now add <code>trace_id=[RANDOM_ID_THAT_YOU_CAN_TRACE]</code> to a request that you want to test manually, or one used by another service, you should be able to easily search for the <code>RANDOM_ID_THAT_YOU_CAN_TRACE</code> in the logs. The best part is, turning it on an off is a matter of using/not using the URL param.</p>

<h1 id="a-slightly-more-advanced-request-tracer">A slightly more advanced Request Tracer</h1>

<p>Of course, the example above is quite naive. It won’t be of much use to anyone, since most errors occur deeper in the call chain. Let’s take the following example:</p>

<pre><code class="language-python">app = Flask(__name__)

@app.route(&quot;/&quot;)
def index():
    name = request.args.get(&quot;name&quot;)
	name = layer1(name)
    return f&quot;Hello, {name}&quot;

def layer1(name: str):
    return layer2(name)

def layer2(name: str):
    return name.upper()
</code></pre>

<p>Our API handler calls another function, which returns the result from yet another. A typical production application is way more complex, having loops and conditional logic all over the place. The problem with nested call chains is that to get the conditional tracing all the way through, one would need to add this to every function.</p>

<pre><code class="language-python">if &quot;trace_id&quot; in request.args:
	# log trace_id, inputs and outputs
</code></pre>

<p>This is very impractical, and would make the code less readable.</p>

<h2 id="custom-tracing-decorator">Custom tracing decorator</h2>

<p>The least obtrusive option I could think of, is creating a custom decorator. We won’t go without modifying our code, but having a decorator on top of each function won’t mess with the readability of the code directly. This is how our tiny app from above would look like:</p>

<pre><code class="language-python">app = Flask(__name__)

tracer = Tracer()

@app.route(&quot;/&quot;)
def index():
    name = request.args.get(&quot;name&quot;)
	# pass the tracer_id to the first function in your call chain
	name = layer1(name, trace_id=request.args.get('trace_id'))
    return f&quot;Hello, {name}&quot;

@tracer.trace
def layer1(name: str):
    return layer2(name)

@tracer.trace
def layer2(name: str):
    return name.upper()
</code></pre>

<p>And this is one possible implementation of a tracing decorator:</p>

<pre><code class="language-python">class Tracer:
    def __init__(self) -&gt; None:
        self.current_trace_id = None

    def trace(self, f):
        @wraps(f)
        def wrapper(*args, **kwargs):
            trace_id = kwargs.pop(&quot;trace_id&quot;, None)
            if trace_id:
                if self.current_trace_id:
                    # Do you really want to raise an error?
                    # Perhaps, logging the concurrent access and silently moving on is better.
                    raise Exception(&quot;Concurrent tracing requests are not allowed!&quot;)

                # &quot;open&quot; a new request
                self.current_trace_id = trace_id
                print(f&quot;Tracing ID: {self.current_trace_id} - function call: {__name__}.{f.__name__} - Arguments: {args}&quot;)
                res = f(*args, **kwargs)

                # &quot;close&quot; the request, by simply clearing its state
                self.current_trace_id = None
                return res
            elif self.current_trace_id:
                print(f&quot;Tracing ID: {self.current_trace_id} - function call: {__name__}.{f.__name__} - Arguments: {args}&quot;)
                return f(*args, **kwargs)
            else:
                return f(*args, **kwargs)

        return wrapper
</code></pre>

<p>Keep in mind the obvious limitation of my approach. The <code>tracer</code> instance is global. Storing state in global variables is usually a bad idea, but in some situations, you just don’t have any other choice.</p>

<p>In WSGI applications, global scope usually means <em>global per process</em>. Traditionally, a WSGI server would spawn a certain number of Python processes, and juggle incoming requests between them. A single request would run end-to-end as part of a single process. If this is the case, then our tiny decorator would do perfectly fine, due to process isolation. When threads or <code>async-await</code> come to play, scoping the decorator to the particular request at hand will become important.</p>

<p>In the case of Flask, one may make use of its <a href="https://flask.palletsprojects.com/en/1.1.x/reqcontext/">Request Scope</a>, which would ensure that a concurrent request won&rsquo;t overwrite the <code>trace_id</code> value of a currently running one. Of course, using a library-specific construct will make code more difficult to test. It will also require modifications to the decorator, in case you switch your Web framework of choice (luckily, most frameworks have the same concept of request scope built in).</p>

<p>At the end, it doesn&rsquo;t matter that much. One of the spirits of Python is writing simple code that gets most of the job done, rather than obsessing about making things uber-generic. If my approach doesn&rsquo;t work for your case, it is easy enough to adapt.</p>

<h1 id="the-inspiration">The Inspiration</h1>

<p>My inspiration came not from the Python community, but by Elixir&rsquo;s Phoenix framework. In its latest version Phoenix comes with an out-of-the-box <a href="https://hexdocs.pm/phoenix_live_dashboard/Phoenix.LiveDashboard.html">LiveDashboard</a>, which is extremely helpful in running an Elixir application in production. Among the many cool features, the dashboard features a Request Logger that pretty much does what I described above.</p>








<div class="embed"
  style="display:flex; flex-wrap: wrap; border: 1px solid #d4d4d4; width:100%; margin-bottom: 1rem">

  
  <div class="embed-image"
    style="flex:1; background: url(https://nts.strzibny.name/img/elixir.png); background-size:cover; background-position:center; min-height: 120px">
  </div>
  

  <div class="embed-content" style="flex:3; padding: 1rem;"><a
      href="https://nts.strzibny.name/phoenix-livedashboard-request-logger/">
      <div class="title"
        style="font-weight: 800; margin-bottom: 1rem; font-size:120%">
        Phoenix 1.5 LiveDashboard’s Request Logger</div>
    </a>
    <div class="embed-description" style="margin-bottom:1rem; font-size:80%">
      Phoenix 1.5-rc.0 is out and so I fired up a new app to see what’s LiveDashboard is all about. Something that stood up for me is the Request Logger.</div>
    <div class="embed-meta" style="font-size:60%">
      <div style="float:left; max-width:80%"><a
          href="https://nts.strzibny.name/phoenix-livedashboard-request-logger/">https://nts.strzibny.name | </a></div>
      <div style="float: right">Created with <a
          href="https://linqable.pro/">Linqable</a></div>
    </div>
  </div>
</div>

                </div>
            </section>

        </article>
        <div id="graphcomment"></div>
        <script type="text/plain" cookie-consent="tracking">

          /* - - - CONFIGURATION VARIABLES - - - */
        
          // make sure the id is yours
          window.gc_params = {
            graphcomment_id: 'preslav-me',
        
            // if your website has a fixed header, indicate it's height in pixels
            fixed_header_height: 0,
          };
        
          /* - - - DON'T EDIT BELOW THIS LINE - - - */
        
          
          (function() {
            var gc = document.createElement('script'); gc.type = 'text/javascript'; gc.async = true;
            gc.src = 'https://graphcomment.com/js/integration.js?' + Math.round(Math.random() * 1e8);
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(gc);
          })();
        
        </script>
    </div>
    </div>
</main>
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
    
    <article class="read-next-card">
        <header class="read-next-card-header">
            <h3><span>More in</span> <a href="/tags/programming">Programming</a></h3>
        </header>
        <div class="read-next-card-content">
            <ul>
                
            </ul>
        </div>
    </article>


    
    
        
    


<article class="post-card post


 ">

        
            <a class="post-card-image-link" href="https://preslav.me/2020/06/01/quote-op-ed-kareem-abdul-jabbar-don-t-understand-the-protests-what-you-re-seeing-is-people-pushed-to-the-edge/">
                <img class="post-card-image"src="https://ca-times.brightspotcdn.com/dims4/default/c9ceddc/2147483647/strip/true/crop/5431x2851" alt="Don’t understand the protests? What you’re seeing is people pushed to the edge"/>
            </a>
        
    
        <div class="post-card-content">
            
    
            <a class="post-card-content-link" href="https://preslav.me/2020/06/01/quote-op-ed-kareem-abdul-jabbar-don-t-understand-the-protests-what-you-re-seeing-is-people-pushed-to-the-edge/">
    
                <header class="post-card-header">
                    
                        
                        <div class="post-card-primary-tag">Quote</div>
                    

                    <h2 class="post-card-title">Don’t understand the protests? What you’re seeing is people pushed to the edge</h2>
                </header>
    
                <section class="post-card-excerpt">
                    <p>What you should see when you see black protesters in the age of Trump and coronavirus is people pushed to the edge, not because they want bars and nail salons open, but because they want to live. To breathe.</p>
                </section>
    
            </a>

            <footer class="post-card-meta">
                    <div class="post-card-byline-content">
                        <span class="post-card-byline-date"><time datetime="2020-106-06">1 June 2020</time>
                            <span class="bull">&bull;</span> 2 min read</span>
                    </div>
                </footer>
    
        </div>

</article>
    

            
        </div>
    </div>
</aside>


        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://preslav.me">Random Bits of Wisdom</a> &copy; 2020</section>
                <nav class="site-footer-nav">
                    <a href="https://preslav.me">Latest Posts</a>
                    
                    <a href="https://twitter.com/preslavrachev" target="_blank" rel="noopener">Twitter</a>
                    <a href="https://github.com/preslavrachev" target="_blank" rel="noopener">Github</a>
                    <a href="/privacy" target="_blank" rel="noopener">Privacy</a>
                    <a href="https://jonathanjanssens.com" target="_blank" rel="noopener" style="opacity: 0.5;">Hugo Casper3 by Jonathan Janssens</a>
                </nav>
            </div>
        </footer>

    </div>

    



<script type="text/javascript" src="/bundle.min.d050a0c3d6a040d6e4f2df0e396650b42a388cecdff4a0a49016fc6feeeceaa1ef57ea994d68bd39794dea102bae81bdb5a7682bfbd0d12751b0b4e0f3ace050.js"
  integrity="sha512-0FCgw9agQNbk8t8OOWZQtCo4jOzf9KCkkBb8b&#43;7s6qHvV&#43;qZTWi9OXlN6hArroG9tadoK/vQ0SdRsLTg86zgUA=="></script>



<script type="text/plain" cookie-consent="tracking">
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
            ga('create', 'UA-131031623-1', 'auto');
            ga('send', 'pageview');
        </script>


<script type="text/plain" cookie-consent="targeting">
    /* Hotjar Tracking Code for https://preslav.me */
(function (h, o, t, j, a, r) {
    h.hj =
      h.hj ||
      function () {
        (h.hj.q = h.hj.q || []).push(arguments);
      };
    h._hjSettings = { hjid: 1770517, hjsv: 6 };
    a = o.getElementsByTagName("head")[0];
    r = o.createElement("script");
    r.async = 1;
    r.src = t + h._hjSettings.hjid + j + h._hjSettings.hjsv;
    a.appendChild(r);
  })(window, document, "https://static.hotjar.com/c/hotjar-", ".js?sv=");
</script>

<script async type="text/plain" cookie-consent="functionality"
  src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<noscript><a href="https://www.FreePrivacyPolicy.com/cookie-consent/">Cookie
    Consent by Free Privacy Policy Generator</a></noscript>


<script type="text/javascript">
  (function () {
    scroll_count = 0;
    function handler() {
      if (scroll_count === 200) {
        document.removeEventListener('scroll', handler);
        goatcounter.count({path: "active_user", title: "The user is actively reading", "event": true});
      } else {
        scroll_count += 1;
      }
    }
    document.addEventListener('scroll', handler)
  })();
</script>

<script data-goatcounter="https://preslav-me.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>

</html>